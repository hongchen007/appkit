<?php/** * Created by PhpStorm. * User: Administrator * Date: 2019/7/17 * Time: 19:27 */namespace app\admin\model;use think\facade\Session;class User extends BaseModel{    /**     * 登录     * @param $date     * @return bool|int     * @throws \think\db\exception\DataNotFoundException     * @throws \think\db\exception\ModelNotFoundException     * @throws \think\exception\DbException     */    public function login($date)    {        $userinfo = $this->where([            'user_name'      => $date['user_name'],            'user_password'  => appkit_hash($date['user_password'])        ])->find();        //验证用户名密码是否正确        if(!$userinfo){            return 3;        }        //存session        Session::set('userinfo',$userinfo);        return true;    }    /**     * 修改密码     * @param $date     * @return bool|int     * @throws \think\Exception     * @throws \think\db\exception\DataNotFoundException     * @throws \think\db\exception\ModelNotFoundException     * @throws \think\exception\DbException     * @throws \think\exception\PDOException     */    public function editpasseord($date)    {        //验证密码是否正确        $sessioninfo = Session::get('userinfo');        $userinfo = $this->where([            'user_name'      => $sessioninfo['user_name'],            'user_password'  => appkit_hash($date['oldPassword'])        ])->find();        if(!$userinfo){            return 3;        }else{            //执行修改            if($this->where(['id'=>$sessioninfo['id']])->update(['user_password'=>appkit_hash($date['user_password'])])){                Session::delete('userinfo');                return true;            }else{                return 11;            }        }    }    //列表页    public function index($data,$limit)    {        $info = $this            ->where($data)            ->paginate($limit);        foreach($info as $k=>$v){            if($v['user_sex'] == '1'){                $info[$k]['user_sex'] = '男';            }else{                $info[$k]['user_sex'] = '女';            }        }        return $info;    }    //添加    public function add_img($arr)    {        //判断用户名是否存在        $userinfo = $this->where('user_name',$arr['user_name'])->find();        if($userinfo){            return 6;        }else{            //数据处理            $arr['create_time'] = date('Y-m-d H:i:s', time());            $arr['update_time'] = date('Y-m-d H:i:s', time());            $info = $this->allowField(true)->save($arr);            if ($info) {                return 1; //添加成功            } else {                return 11; //添加失败            }        }    }    //删除    public function img_del($date)    {        if ($this->where('id', $date)->delete()) {            return 1; //删除成功        } else {            return 2;//删除失败        }    }    //修改信息    public function updateinfo($date)    {        $arr = $this->find($date);        return $arr;    }    /**     * 执行修改     * @param $date     */    public function updateedit($date)    {        $date['update_time'] = date('Y-m-d H:i:s', time());        $userinfo = $this->where('id',$date['id'])->find();        if($date['user_password'] == $userinfo['user_password']){            unset($date['user_password']);        }else{            $date['user_password'] = appkit_hash($date['user_password']);        }        if ($this->allowField(true)->isUpdate(true)->update($date)) {            return 1; //修改成功        } else {            return 11; //修改失败        }    }}