<?php/** * Created by PhpStorm. * User: Administrator * Date: 2019/7/23 * Time: 17:18 */namespace app\admin\controller;use think\Request;use think\Db;class Features extends Base{    //列表页显示    public function index()    {        return $this->fetch();    }    //轮播图列表    public function imglist(Request $request)    {        try {            $info = Db::table('kit_features')                ->alias('a')                ->join('kit_lcon b', 'a.features_lcon_id = b.id')                ->order('a.id desc')                ->field('a.id, a.features_img, a.features_des, b.lcon_value, b.lcon_pic')                ->paginate($request->param('limit'));            echo ajax($info->toArray()['data'], $info->toArray()['total'], 'Success');        } catch (\Exception $exception) {            return $exception->getMessage();        }    }    //删除图片    public function img_del(Request $request)    {        if (!$request->param('id')) {            //参数不存在修改失败            echo 2;        }        $info = Db::table('kit_features')->where('id', $request->param('id'))->find();        $del  = Db::table('kit_features')->where('id', $request->param('id'))->delete();        if ($del) {            unlink($_SERVER["DOCUMENT_ROOT"].$info['features_img']);            echo 1; //删除成功        } else {            echo 2;//删除失败        }    }    //添加轮播图片页面显示    public function add_img()    {        $info = Db::table('kit_lcon')->select();        $this->assign('info',$info);        return $this->fetch();    }    //上传图片 建议使用此方法当公共    public function upload()    {        // 获取表单上传文件 例如上传了001.jpg        $file = request()->file('file');        // 移动到框架应用根目录/uploads/ 目录下        $info = $file->move('./uploads');        if ($info) {            // 输出 20160820/42a79759f284b767dfcb2a0197904287.jpg            echo ajax('/uploads/' . $info->getSaveName());        } else {            return false;        }    }    //添加    public function add_insert(Request $request)    {        //取所有值 先验证        $arr = $request->param();        if(!preg_match('/^.{3,50}$/',$arr['features_des'])){            echo 3; //功能描述 必须要3到50个字符        }else if(empty($arr['features_img'])){            echo 4; //图片不能为空        }else{            $arr['create_time'] = date('Y-m-d H:i:s', time());            $arr['update_time'] = date('Y-m-d H:i:s', time());            $lcon = Db::table('kit_lcon')->field('id')->where('lcon_value',$request->param('locn'))->find();            $arr['features_lcon_id'] = $lcon['id'];            unset($arr['locn']);            $info = Db::table('kit_features')->insert($arr);            if ($info) {                echo 1; //添加成功            } else {                echo 2; //添加失败            }        }    }    //修改    public function update_edit(Request $request)    {        if ($request->isPost()) {            //取所有值 取值我是取所有只要前端传输的参数跟数据库一致            $arr = $request->param();            if(!preg_match('/^.{3,50}$/',$arr['features_des'])){                echo 3; //功能描述 必须要3到50个字符            }else{                if (!$request->param('features_img')) {                    //没有改图片，但是还要检测下 img是否存在 不然给有地址的赋值一个空就不好了                    unset($arr['features_img']);                    $lcon = Db::table('kit_lcon')->field('id')->where('lcon_value',$request->param('locn'))->find();                    $arr['features_lcon_id'] = $lcon['id'];                    $arr['update_time'] = date('Y-m-d H:i:s', time());                    unset($arr['locn']);                    $info = Db::table('kit_features')->where('id', $arr['id'])->update($arr);                    if ($info) {                        echo 1; //修改成功                    } else {                        echo 2; //修改失败                    }                }else{                    //修改图片，删除原来的图片                    $del  = Db::table('kit_features')->where('id', $arr['id'])->find();                    $lcon = Db::table('kit_lcon')->field('id')->where('lcon_value',$request->param('locn'))->find();                    $arr['features_lcon_id'] = $lcon['id'];                    $arr['update_time'] = date('Y-m-d H:i:s', time());                    unset($arr['locn']);                    $info = Db::table('kit_features')->where('id', $arr['id'])->update($arr);                    if ($info) {                        unlink($_SERVER["DOCUMENT_ROOT"].$del['features_img']);                        echo 1; //修改成功                    } else {                        echo 2; //修改失败                    }                }            }        }else{            //取轮播图find一条在修改前显示的数据            $arr = Db::table('kit_features')->find($request->param('id'));            $info  = Db::table('kit_lcon')->select();            $this->assign('arr', $arr);            $this->assign('info', $info);            return $this->fetch();        }    }}